<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#1e3a8a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="mobile-web-app-capable" content="yes">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Nesne Takip - Plaka / Birim / SIM / IMEI</title>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary: #1e3a8a;
            --accent: #3b82f6;
            --success: #10b981;
            --card-bg: #0b1120;
            --surface: #020617;
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
            margin: 0;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 14px 10px;
            background:
                radial-gradient(circle at top, #1d4ed8 0%, #020617 40%, #000000 100%);
            color: #e5e7eb;
        }

        /* Telefon √ßer√ßevesi (Android benzeri) */
        .app-shell {
            position: relative;
            width: 100%;
            max-width: 520px;
            max-height: 900px;
            border-radius: 32px;
            background: radial-gradient(circle at top left, rgba(51, 65, 85, 0.7), rgba(15, 23, 42, 0.95));
            box-shadow:
                0 24px 55px rgba(0, 0, 0, 0.85),
                0 0 0 1px rgba(148, 163, 184, 0.08);
            overflow: hidden;
            backdrop-filter: blur(28px);
            -webkit-backdrop-filter: blur(28px);
            border: 1px solid rgba(15, 23, 42, 0.8);
            display: flex;
            flex-direction: column;
        }

        /* √úst sistem bar (saat, sinyal, pil) */
        .system-bar {
            height: 22px;
            padding: 0 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 0.7rem;
            color: rgba(248, 250, 252, 0.92);
            background: linear-gradient(180deg, rgba(15, 23, 42, 0.9), transparent);
        }

        .system-bar-left,
        .system-bar-right {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .system-dot {
            width: 6px;
            height: 6px;
            border-radius: 999px;
            background: #22c55e;
        }

        .system-signal {
            width: 14px;
            height: 8px;
            border-radius: 2px;
            border: 1px solid rgba(248, 250, 252, 0.9);
            position: relative;
        }

        .system-signal::after {
            content: "";
            position: absolute;
            inset: 1px;
            border-radius: 1px;
            background: rgba(248, 250, 252, 0.9);
        }

        .system-battery {
            width: 18px;
            height: 8px;
            border-radius: 2px;
            border: 1px solid rgba(248, 250, 252, 0.9);
            position: relative;
            margin-left: 3px;
        }

        .system-battery::after {
            content: "";
            position: absolute;
            inset: 1px 2px 1px 1px;
            border-radius: 1px;
            background: rgba(248, 250, 252, 0.9);
        }

        .system-battery::before {
            content: "";
            position: absolute;
            right: -2px;
            top: 2px;
            width: 1px;
            height: 4px;
            border-radius: 1px;
            background: rgba(248, 250, 252, 0.9);
        }

        /* Uygulama √ºst barƒ± */
        .app-header {
            padding: 14px 18px 12px;
            background: linear-gradient(135deg, #0b1f3a, #1d4ed8);
            color: #f9fafb;
            box-shadow: 0 2px 8px rgba(15, 23, 42, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .app-header-title {
            font-size: 1.1rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            text-align: center;
        }

        /* Asƒ±l i√ßerik alanƒ± */
        .app-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 14px 12px 8px;
            background:
                radial-gradient(circle at top left, rgba(59, 130, 246, 0.18), transparent 55%),
                radial-gradient(circle at bottom right, rgba(15, 23, 42, 0.9), #020617);
        }

        .container {
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at top, rgba(30, 64, 175, 0.12), rgba(15, 23, 42, 0.98));
            border-radius: 18px;
            padding: 16px 14px 14px;
            box-shadow:
                0 12px 30px rgba(15, 23, 42, 0.95),
                0 0 0 1px rgba(148, 163, 184, 0.12);
            border-top: 3px solid rgba(59, 130, 246, 0.7);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            color: #e5e7eb;
        }

        h1 {
            color: #e5edff;
            font-size: 1.1rem;
            margin: 0 0 18px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        h1 span.emoji {
            font-size: 1.4rem;
        }

        h1 span.text {
            flex: 1;
        }

        .title-sub {
            display: block;
            font-size: 0.8rem;
            margin-top: 2px;
            color: #9ca3af;
        }

        .section {
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid rgba(30, 64, 175, 0.6);
        }
        .section:last-of-type { border-bottom: none; }
        .section h2 { font-size: 0.86rem; color: #bfdbfe; margin: 0 0 10px; font-weight: 700; letter-spacing: 0.3px; text-transform: uppercase; }
        .section-excel {
            background: radial-gradient(circle at top left, rgba(37, 99, 235, 0.16), rgba(15, 23, 42, 0.98));
            border: 1px solid rgba(148, 163, 184, 0.32);
            border-radius: 14px;
            padding: 16px 14px;
            margin-bottom: 14px;
            box-shadow: 0 8px 18px rgba(15, 23, 42, 0.75);
        }

        .section-excel .section-excel-title {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            font-size: 0.85rem;
            font-weight: 700;
            color: #bfdbfe;
            text-transform: uppercase;
            letter-spacing: 0.25em;
        }
        .section-excel .section-excel-title span.icon { font-size: 1.25rem; }
        .section-excel .row { margin-bottom: 10px; }
        .section-excel .row:last-of-type { margin-bottom: 0; }
        .status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 999px;
            font-size: 11px;
            font-weight: 600;
        }

        .status-badge.empty {
            background: rgba(15, 23, 42, 0.6);
            color: #9ca3af;
            border: 1px dashed rgba(148, 163, 184, 0.5);
        }

        .status-badge.loaded {
            background: rgba(16, 185, 129, 0.12);
            color: #6ee7b7;
            border: 1px solid rgba(34, 197, 94, 0.8);
        }

        .file-input-wrap {
            background: rgba(15, 23, 42, 0.95);
            border: 1px dashed rgba(148, 163, 184, 0.7);
            border-radius: 10px;
            padding: 10px 12px;
        }

        .file-input-wrap:focus-within { border-color: var(--accent); outline: none; }

        .row {
            display: flex;
            gap: 12px;
            margin-bottom: 10px;
            flex-wrap: wrap;
            align-items: flex-end;
        }

        .col { display: flex; flex-direction: column; gap: 4px; min-width: 140px; }
        .col.wide { min-width: 200px; }

        label {
            font-size: 11px;
            font-weight: 600;
            color: #9ca3af;
            text-transform: uppercase;
            letter-spacing: 0.15em;
        }

        input,
        select {
            padding: 11px 10px 9px;
            border-radius: 9px;
            border: 1px solid rgba(148, 163, 184, 0.7);
            background: rgba(15, 23, 42, 0.9);
            color: #e5e7eb;
            font-size: 14px;
            transition: border-color 0.18s ease, box-shadow 0.18s ease, background 0.18s ease, transform 0.05s ease;
        }

        input::placeholder {
            color: #6b7280;
        }

        input:focus,
        select:focus {
            outline: none;
            border-color: var(--accent);
            background: rgba(15, 23, 42, 0.95);
            box-shadow:
                0 0 0 1px rgba(59, 130, 246, 0.6),
                0 6px 14px rgba(15, 23, 42, 0.9);
            transform: translateY(-1px);
        }

        .btn {
            padding: 11px 18px;
            border: none;
            border-radius: 999px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            box-shadow: 0 4px 14px rgba(15, 23, 42, 0.85);
            transition: transform 0.07s ease, box-shadow 0.14s ease, filter 0.12s ease, background 0.18s ease;
        }

        .btn-primary { background: linear-gradient(135deg, #2563eb, #1d4ed8); color: white; }
        .btn-success { background: linear-gradient(135deg, #22c55e, #16a34a); color: white; }
        .btn-light { background: rgba(30, 64, 175, 0.16); color: #e5e7eb; border: 1px solid rgba(148, 163, 184, 0.5); }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            box-shadow: none;
        }

        .btn:hover:not(:disabled) {
            filter: brightness(1.05);
            transform: translateY(-1px);
            box-shadow: 0 6px 18px rgba(15, 23, 42, 0.95);
        }

        .btn:active:not(:disabled) {
            transform: translateY(1px) scale(0.99);
            box-shadow: 0 3px 10px rgba(15, 23, 42, 0.9);
        }

        .test-modu-wrap {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 11px;
            color: #9ca3af;
            cursor: pointer;
        }

        .test-modu-wrap input { cursor: pointer; }

        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.72);
            z-index: 100;
            align-items: flex-start;
            justify-content: center;
            overflow-y: auto;
            padding: 16px 10px 24px;
            -webkit-overflow-scrolling: touch;
        }

        .modal-overlay.acik { display: flex; }

        .modal-panel {
            background: radial-gradient(circle at top, #0f172a, #020617 65%);
            border-radius: 18px;
            padding: 20px 16px 16px;
            max-width: 420px;
            width: 90%;
            box-shadow:
                0 18px 40px rgba(15, 23, 42, 0.98),
                0 0 0 1px rgba(148, 163, 184, 0.35);
            border-top: 3px solid rgba(37, 99, 235, 0.9);
            margin: auto;
        }

        /* Y√∂netici paneli uzun: Ana Liste en √ºstte, a≈üaƒüƒ± kaydƒ±rƒ±nca hepsi g√∂r√ºn√ºr */
        #yoneticiPaneliOverlay .modal-panel {
            max-height: min(90vh, 800px);
            overflow-y: auto;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
        }

        .modal-panel h3 {
            margin: 0;
            color: #dbeafe;
            font-size: 0.95rem;
            text-transform: uppercase;
            letter-spacing: 0.16em;
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            margin-bottom: 10px;
        }

        .modal-close {
            border: none;
            background: transparent;
            color: #9ca3af;
            font-size: 18px;
            line-height: 1;
            padding: 4px 6px;
            border-radius: 999px;
            cursor: pointer;
            transition: background 0.15s ease, color 0.15s ease, transform 0.05s ease;
        }

        .modal-close:hover {
            background: rgba(148, 163, 184, 0.18);
            color: #e5e7eb;
            transform: translateY(-1px);
        }

        .modal-panel textarea {
            width: 100%;
            min-height: 120px;
            padding: 10px;
            border: 1px solid rgba(148, 163, 184, 0.7);
            border-radius: 10px;
            font-size: 14px;
            resize: vertical;
            box-sizing: border-box;
            background: rgba(15, 23, 42, 0.98);
            color: #e5e7eb;
        }

        .modal-panel .helper { margin-top: 6px; }
        .modal-panel .btn { margin-top: 12px; margin-right: 8px; }

        .helper {
            font-size: 11px;
            color: #9ca3af;
            margin-top: 6px;
            line-height: 1.4;
        }

        .plaka-wrapper {
            display: inline-flex;
            align-items: center;
            border: 1px solid rgba(148, 163, 184, 0.7);
            border-radius: 999px;
            background: rgba(15, 23, 42, 0.96);
            padding: 0 10px;
            box-shadow: 0 4px 12px rgba(15, 23, 42, 0.9);
        }

        .plaka-wrapper .plaka-prefix {
            font-weight: 600;
            color: #bfdbfe;
            font-size: 15px;
        }

        .plaka-wrapper input {
            border: none;
            padding: 10px 0;
            margin-left: 4px;
            min-width: 90px;
            font-size: 15px;
            text-align: left;
            letter-spacing: 1px;
            background: transparent;
            color: #e5e7eb;
        }

        .plaka-wrapper input::placeholder { color: #6b7280; }
        .plaka-wrapper input:focus { outline: none; }

        /* Kayƒ±t sayacƒ± rozeti */
        .header-counter {
            margin-left: 10px;
            padding: 3px 10px;
            border-radius: 999px;
            background: rgba(15, 23, 42, 0.85);
            border: 1px solid rgba(191, 219, 254, 0.7);
            font-size: 0.75rem;
            font-weight: 600;
            color: #bfdbfe;
            white-space: nowrap;
        }

        /* Kullanƒ±ldƒ±ƒüƒ± yer alanƒ± okunaklƒ± olsun */
        #kullanildigiYer {
            background: #e5edff !important;
            color: #1e3a8a !important;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 12px;
            border-radius: 10px;
            overflow: hidden;
        }

        th,
        td {
            border: 1px solid rgba(30, 64, 175, 0.8);
            padding: 8px;
            text-align: left;
        }

        th {
            background: radial-gradient(circle at top, rgba(37, 99, 235, 0.55), rgba(15, 23, 42, 0.98));
            color: #e5edff;
            font-weight: 600;
        }

        tr:nth-child(even) { background: rgba(15, 23, 42, 0.85); }
        tr:nth-child(odd) { background: rgba(15, 23, 42, 0.9); }

        /* Mobil g√∂r√ºn√ºm */
        @media (max-width: 768px) {
            body { padding: 10px 8px; }
            .app-shell { max-width: 100%; max-height: none; border-radius: 28px; }
            .app-main { padding: 12px 10px 8px; }
            .container { padding: 14px 11px 11px; border-radius: 16px; }
            h1 { font-size: 1rem; margin-bottom: 14px; }
            .section { margin-bottom: 16px; padding-bottom: 12px; }
            .section h2 { font-size: 0.8rem; margin-bottom: 8px; }
            .section-excel { padding: 12px 10px; }
            .row { flex-direction: column; gap: 10px; margin-bottom: 10px; }
            .col, .col.wide { min-width: 0; width: 100%; }
            .col[style*="align-self"] { align-self: stretch !important; }
            label { font-size: 11px; }
            input, select { padding: 12px 10px; font-size: 16px; min-height: 44px; }
            .btn { padding: 12px 16px; min-height: 44px; font-size: 14px; width: 100%; }
            .row .btn { width: auto; min-width: 0; }
            .plaka-wrapper { width: 100%; min-width: 0; }
            .plaka-wrapper input { min-width: 60px; font-size: 16px; }
            .test-modu-wrap { font-size: 11px; width: 100%; }
            .modal-panel { padding: 20px 16px; width: 95%; max-width: none; }
            #listeAlani { overflow-x: auto; -webkit-overflow-scrolling: touch; }
            #listeAlani table { font-size: 11px; min-width: 600px; }
            #listeAlani th, #listeAlani td { padding: 8px 6px; }
        }
        @media (max-width: 480px) {
            body { padding: 8px 6px; }
            .app-shell { border-radius: 24px; }
            .container { padding: 12px 9px; }
            h1 { font-size: 0.95rem; }
        }

        /* Alt gezinme √ßubuƒüu (Android navigation) */
        .bottom-nav {
            height: 40px;
            padding: 6px 28px 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 26px;
            background: radial-gradient(circle at top, rgba(15, 23, 42, 0.9), transparent 60%);
            border-top: 1px solid rgba(148, 163, 184, 0.35);
        }

        .nav-pill {
            width: 46px;
            height: 4px;
            border-radius: 999px;
            background: rgba(148, 163, 184, 0.65);
        }

        .nav-circle {
            width: 10px;
            height: 10px;
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 184, 0.8);
        }

        .nav-square {
            width: 9px;
            height: 9px;
            border-radius: 2px;
            border: 1px solid rgba(148, 163, 184, 0.9);
        }
    </style>
</head>
<body>
<div class="app-shell">
    <div class="system-bar">
        <div class="system-bar-left">
            <span class="system-dot"></span>
            <span id="systemTime">12:30</span>
        </div>
        <div class="system-bar-right">
            <div class="system-signal"></div>
            <div class="system-battery"></div>
        </div>
    </div>

    <header class="app-header">
        <div class="app-header-title">
            NTP Cƒ∞HAZLARI
            <span id="headerCounter" class="header-counter">Kayƒ±t: 0</span>
        </div>
    </header>

    <main class="app-main">
        <div class="container">
            <h1>
                <span class="emoji">üìã</span>
                <span class="text">
                    ABDURRAHMAN KALAYCI ‚Äì MEKƒ∞N K√úL
                    <span class="title-sub">Sistem ve G√ºvenlik B√ºro Amirliƒüi</span>
                </span>
            </h1>

    <div class="section" style="flex:0 0 auto;">
        <h2>3. Kayƒ±t Giri≈üi</h2>
        <div class="row">
            <div class="col">
                <label>PLAKA NO</label>
                <div class="plaka-wrapper">
                    <span class="plaka-prefix">10 A </span>
                    <input type="text" id="plaka" placeholder="......." inputmode="numeric" maxlength="6" oninput="plakaRakamGirildi(this); plakaDegisti()">
                </div>
            </div>
            <div class="col wide">
                <label>KULLANILDIƒûI YER</label>
                <input type="text" id="kullanildigiYer" placeholder="Plaka yazƒ±nca otomatik gelir" readonly style="background:#f1f5f9;">
            </div>
        </div>
        <div class="row">
            <div class="col">
                <label>Cƒ∞NSƒ∞</label>
                <input type="text" id="cinsi" placeholder="Cinsi">
            </div>
            <div class="col">
                <label>MARKA</label>
                <input type="text" id="marka" placeholder="Marka">
            </div>
            <div class="col">
                <label>MODEL YILI</label>
                <input type="text" id="modelYili" placeholder="√ñrn. 2020">
            </div>
        </div>
        <div class="row">
            <div class="col">
                <label>DURUMU</label>
                <input type="text" id="durumu" placeholder="Durum">
            </div>
            <div class="col">
                <label>RESMƒ∞/Sƒ∞Vƒ∞L</label>
                <input type="text" id="resmiSivil" placeholder="Resmi/Sivil">
            </div>
            <div class="col">
                <label>Cƒ∞HAZ T√úR√ú (NTP T√úR√ú ‚Äì tablolardan otomatik veya elle)</label>
                <input type="text" id="cihazTuru" placeholder="Plaka yazƒ±nca otomatik gelir; gelmezse yazƒ±n">
            </div>
        </div>
        <div class="row">
            <div class="col">
                <label>Sƒ∞M NO <span style="color:#dc2626;">*</span></label>
                <input type="text" id="simNo" placeholder="(5xx) xxx xx xx" maxlength="15" oninput="simNoMask(this)" onblur="simNoImeiDoldur()">
                <p id="simImeiInfo" class="helper" style="display:none;"></p>
            </div>
            <div class="col">
                <label>IMEI NO</label>
                <input type="text" id="imeiNo" placeholder="IMEI numarasƒ± (opsiyonel)" onfocus="simNoImeiDoldur()">
            </div>
            <div class="col">
                <label>EKƒ∞P KODU</label>
                <input type="text" id="ekipKodu" placeholder="Ekip kodu">
            </div>
        </div>
        <div class="row">
            <button class="btn btn-primary" onclick="kaydet()">Kaydet</button>
            <button type="button" class="btn btn-light" onclick="arsiveTasi()">Ar≈üiv</button>
            <button type="button" id="btnExcelGonder" class="btn btn-success" onclick="excelGonderWhatsApp()" disabled title="Ar≈üivde en az 5 kayƒ±t olunca aktif olur">Excel listesini g√∂nder</button>
            <button type="button" class="btn btn-light" onclick="yoneticiPaneliAc()">Y√∂netici Paneli</button>
        </div>
        <div class="row">
            <div class="col wide">
                <label>Bƒ∞Rƒ∞M / KULLANILDIƒûI YER ARAMA</label>
                <input type="text" id="birimArama" placeholder="√ñrn: Asayi≈ü, Trafik ≈ûube, ASELSAN, ATOSƒ∞S, Dƒ∞ƒûER ...">
            </div>
            <div class="col" style="align-self:flex-end; min-width:140px;">
                <button type="button" class="btn btn-light" onclick="birimAramaAc()">Birimdeki Cihazlarƒ± G√∂ster</button>
            </div>
        </div>
    </div>

    <div id="yoneticiPaneliOverlay" class="modal-overlay" onclick="if(event.target===this) yoneticiPaneliKapat()">
        <div class="modal-panel">
            <div class="modal-header">
                <h3>Y√∂netici Paneli</h3>
                <button type="button" class="modal-close" onclick="yoneticiPaneliKapat()" aria-label="Ana sayfaya d√∂n">‚úï</button>
            </div>

            <div class="section" style="margin-bottom:12px; padding-bottom:10px; border-bottom:1px solid rgba(30,64,175,0.6);">
                <h2>1. Ana Excel Listesi (Veritabanƒ±)</h2>
                <div class="section-excel">
                    <div class="section-excel-title"><span class="icon">üìÅ</span> ANA Lƒ∞STE EXCEL</div>
                    <div class="row">
                        <div class="col wide">
                            <label>Excel Dosyasƒ± (Ana Liste Ba≈ülƒ±klarƒ±yla)</label>
                            <div class="file-input-wrap">
                                <input type="file" id="listeExcel" accept=".xlsx,.xls" onchange="anaExcelYukle(this)">
                            </div>
                        </div>
                        <div class="col" style="align-self: center;">
                            <span id="listeDurum" class="status-badge empty">Dosya se√ßilmedi</span>
                        </div>
                    </div>
                    <p class="helper">Excel ba≈ülƒ±klarƒ±: <b>KULLANILDIƒûI YER</b>, <b>Cƒ∞NSƒ∞</b>, <b>MARKA</b>, <b>MODEL YILI</b>, <b>DURUMU</b>, <b>RESMƒ∞/Sƒ∞Vƒ∞L</b>, <b>PLAKA NO</b>. Bir kez y√ºkleyin ‚Äî tarayƒ±cƒ±da sabit kalƒ±r, her a√ßƒ±lƒ±≈üta otomatik y√ºkl√º.</p>
                </div>
            </div>

            <div class="section" style="margin-bottom:12px; padding-bottom:10px; border-bottom:1px solid rgba(30,64,175,0.6);">
                <h2>2. Cihaz T√ºr√º Excel (Plaka - NTP T√ºr√º)</h2>
                <div class="section-excel">
                    <div class="section-excel-title"><span class="icon">üìã</span> Cƒ∞HAZ T√úR√ú Lƒ∞STESƒ∞</div>
                    <p class="helper" style="margin-bottom: 12px;">Sadece <b>PLAKA</b> ve <b>NTP T√úR√ú</b> s√ºtunlarƒ± olan tek Excel dosyasƒ±nƒ± y√ºkleyin. Plaka girince ana tabloya NTP t√ºr√º bu listeden yazƒ±lƒ±r. <b>Bir kere y√ºkleyince sabit kalƒ±r ‚Äî her a√ßƒ±lƒ±≈üta otomatik y√ºkl√º.</b> Plakayƒ± "0282" veya "0282A" gibi yazƒ±n; A olmadan da aranƒ±r.</p>
                    <div class="row">
                        <div class="col wide">
                            <label>Cihaz T√ºr√º Excel (PLAKA + NTP T√úR√ú)</label>
                            <div class="file-input-wrap">
                                <input type="file" id="excelCihazTuru" accept=".xlsx,.xls" onchange="cihazTuruExcelYukle(this)">
                            </div>
                        </div>
                        <div class="col" style="align-self: center;">
                            <span id="durumCihazTuru" class="status-badge empty">Dosya se√ßilmedi</span>
                        </div>
                        <div class="col" style="align-self: center;">
                            <button type="button" class="btn btn-light" onclick="cihazTuruListesiniSifirla()" title="Hafƒ±zadaki cihaz t√ºr√º listesini siler">Cihaz t√ºr√º listesini sƒ±fƒ±rla</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="section" style="margin-bottom:12px; padding-bottom:10px; border-bottom:1px solid rgba(30,64,175,0.6);">
                <h2>Varolan Kayƒ±tlar (SIM - IMEI)</h2>
                <div class="section-excel">
                    <div class="section-excel-title"><span class="icon">üì±</span> SIM - IMEI Lƒ∞STESƒ∞</div>
                    <p class="helper" style="margin-bottom: 12px;">Excel'de <b>SIM NO</b> (veya Sƒ∞M NO) ve <b>IMEI</b> s√ºtunlarƒ± zorunlu; <b>PLAKA</b> s√ºtunu varsa Sƒ∞M girildiƒüinde plaka da otomatik dolar ve o plakaya ait Kullanƒ±ldƒ±ƒüƒ± Yer, Marka, Model, Cihaz T√ºr√º ana tablodan gelir. Bir kez y√ºkleyince sabit kalƒ±r ‚Äî her a√ßƒ±lƒ±≈üta otomatik y√ºkl√º.</p>
                    <div class="row">
                        <div class="col wide">
                            <label>Varolan kayƒ±tlar Excel (SIM NO + IMEI)</label>
                            <div class="file-input-wrap">
                                <input type="file" id="excelSimImei" accept=".xlsx,.xls" onchange="simImeiExcelYukle(this)">
                            </div>
                        </div>
                        <div class="col" style="align-self: center;">
                            <span id="durumSimImei" class="status-badge empty">Dosya se√ßilmedi</span>
                        </div>
                        <div class="col" style="align-self: center;">
                            <button type="button" class="btn btn-light" onclick="simImeiListesiniSifirla()" title="Hafƒ±zadaki SIM-IMEI listesini siler">SIM-IMEI listesini sƒ±fƒ±rla</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="section" style="margin-bottom:8px; padding-bottom:8px; border-bottom:1px solid rgba(30,64,175,0.6);">
                <h2>WhatsApp Numaralarƒ±</h2>
                <p class="helper">Excel listesini g√∂nder dediƒüinizde indirilen dosya bu numaralara a√ßƒ±lacak sohbetlerle WhatsApp Web'de a√ßƒ±lƒ±r. Her satƒ±ra bir numara (5xxxxxxxxx veya 05xxxxxxxxx).</p>
                <textarea id="yoneticiNumaralar" placeholder="Her satƒ±ra bir numara: 5321112233 veya 05xx xxx xx xx"></textarea>
            </div>

            <div class="section" style="margin-bottom:8px; padding-bottom:8px; border-bottom:1px solid rgba(30,64,175,0.6);">
                <h2>HEKDEN GELENLER Listesi</h2>
                <p class="helper">Sƒ∞M girildiƒüinde plaka otomatik dolduƒüunda veya plaka/birim bu listede varsa uyarƒ± g√∂sterilir. Her satƒ±ra bir plaka (√∂rn. 0282) veya birim adƒ± yazƒ±n.</p>
                <textarea id="hekListesi" placeholder="Her satƒ±ra plaka veya birim: 0282, ASELSAN, Trafik ≈ûube ..."></textarea>
            </div>

            <div class="section" style="margin-bottom:4px; padding-bottom:4px; border-bottom:none;">
                <h2>3. Kayƒ±t ve Ar≈üiv Listesi</h2>
                <p class="helper">Bug√ºn girilen kayƒ±tlar ve ar≈üivdeki cihazlarƒ± buradan inceleyebilir, Excel veya PDF olarak alabilirsiniz.</p>
                <div class="row" style="flex-direction:row; align-items:center; gap:8px; margin-bottom:10px;">
                    <button class="btn btn-light" style="padding:8px 12px; font-size:12px; white-space:nowrap;" onclick="exceleAktar()">Aktif kayƒ±tlarƒ± Excel'e aktar</button>
                    <button class="btn btn-light" style="padding:8px 12px; font-size:12px; white-space:nowrap;" onclick="arsivPdfGoster()">Ar≈üivi PDF olarak g√∂ster</button>
                </div>
                <div class="row">
                    <div class="col" style="min-width:0;">
                        <label>Aktif Kayƒ±tlar</label>
                        <div id="listeAlani" style="max-height:160px; overflow-x:auto; overflow-y:auto; -webkit-overflow-scrolling:touch;"></div>
                    </div>
                </div>
                <div class="row">
                    <div class="col" style="min-width:0;">
                        <label>Ar≈üivdeki Kayƒ±tlar</label>
                        <div id="arsivAlani" style="max-height:160px; overflow-x:auto; overflow-y:auto; -webkit-overflow-scrolling:touch;"></div>
                    </div>
                </div>
            </div>

            <div>
                <button type="button" class="btn btn-primary" onclick="yoneticiNumaralariKaydet(); hekListesiKaydet(); yoneticiPaneliKapat();">Kaydet</button>
                <button type="button" class="btn btn-light" onclick="yoneticiPaneliKapat()">Kapat</button>
            </div>
        </div>
    </div>

    <!-- Birim arama sonu√ß penceresi -->
    <div id="birimAramaOverlay" class="modal-overlay" onclick="if(event.target===this) birimAramaKapat()">
        <div class="modal-panel">
            <h3>Birimdeki Cihazlar</h3>
            <p id="birimAramaBaslik" class="helper"></p>
            <div id="birimAramaSonuc" style="max-height:320px; overflow:auto; -webkit-overflow-scrolling:touch;"></div>
            <div style="margin-top:10px; text-align:right;">
                <button type="button" class="btn btn-light" onclick="birimAramaKapat()">Kapat</button>
            </div>
        </div>
    </div>

    <p class="helper" style="margin-top:6px;font-size:10px;color:#9ca3af">Nesne Takip v2 ‚Äî Tek Cƒ∞HAZ T√úR√ú Excel, plaka 0282/0282A arama, sabit y√ºkleme. G√ºncel deƒüilse Ctrl+F5 ile yenileyin.</p>
        </div>
    </main>

    <div class="bottom-nav" aria-hidden="true">
        <div class="nav-square"></div>
        <div class="nav-pill"></div>
        <div class="nav-circle"></div>
    </div>
</div>

<script>
    // Yeni Excel ba≈ülƒ±klarƒ± (kalƒ±cƒ±)
    const ANA_BASLIKLAR = ['KULLANILDIƒûI YER', 'Cƒ∞NSƒ∞', 'MARKA', 'MODEL YILI', 'DURUMU', 'RESMƒ∞/Sƒ∞Vƒ∞L', 'PLAKA NO'];
    const EXPORT_BASLIKLAR = ['S. N.', 'KULLANILDIƒûI YER', 'Cƒ∞NSƒ∞', 'MARKA', 'MODEL YILI', 'DURUMU', 'RESMƒ∞/Sƒ∞Vƒ∞L', 'PLAKA NO', 'Cƒ∞HAZ T√úR√ú', 'EKƒ∞P KODU', 'Sƒ∞M NO', 'IMEI NO'];
    const GONDER_BASLIKLAR = ['PLAKA', 'Bƒ∞Rƒ∞Mƒ∞', 'EKƒ∞P KODU', 'Sƒ∞M NO', 'IMEI NO'];

    let PLAKA_VERI = {};  // normalized plaka -> { kullanildigiYer, cinsi, marka, modelYili, durumu, resmiSivil }
    let PLAKA_NTP = {};   // tek anahtar per plaka -> NTP T√úR√ú (satƒ±r sayƒ±sƒ± = kayƒ±t sayƒ±sƒ±)
    let SIM_IMEI = {};    // sim no (10 rakam) -> { imei, plaka } (plaka opsiyonel; Sim_imei.xlsx'te Plaka s√ºtunu varsa dolar)
    let HEKDEN_GELENLER = [];  // plaka veya birim adƒ±; listede varsa uyarƒ± g√∂sterilir
    let CIHAZ_TURU_SAYAC = 0;  // Excel'deki ger√ßek satƒ±r sayƒ±sƒ± (g√∂sterim i√ßin)
    let KAYITLAR = [];
    let ARSIV_KAYITLAR = [];
    let siraNo = 0;
    let TOPLAM_CIHAZ = 0;

    function plakaNormalize(str) {
        if (str == null || str === '') return '';
        const s = String(str).trim().replace(/\s+/g, '').toUpperCase();
        return s;
    }

    // Sayƒ±sal plakalar i√ßin tek bi√ßim: 282 ve 0282 -> "0282" (4 hane)
    function plakaCanonicalKey(str) {
        const norm = plakaNormalize(str);
        if (!norm) return '';
        if (/^\d+$/.test(norm)) return norm.padStart(4, '0');
        if (/^\d+A$/i.test(norm)) return norm.replace(/A$/i, '').padStart(4, '0') + 'A';
        return norm;
    }

    // Plaka alanƒ±: sabit "10 A " + sadece rakam. Tam plaka metnini d√∂nd√ºr√ºr.
    function getPlakaTam() {
        const inp = document.getElementById('plaka');
        if (!inp) return '';
        const rakam = (inp.value || '').replace(/\D/g, '');
        return rakam ? '10 A ' + rakam : '';
    }

    // Sadece rakam girilsin
    function plakaRakamGirildi(inp) {
        const v = (inp.value || '').replace(/\D/g, '');
        if (inp.value !== v) inp.value = v;
    }

    // Sƒ∞M NO maskesi: (5xx) xxx xx xx ‚Äî 10 rakam
    function simNoMask(inp) {
        let v = (inp.value || '').replace(/\D/g, '');
        if (v.length > 10) v = v.slice(0, 10);
        let formatted = '';
        if (v.length > 0) formatted = '(' + v.slice(0, 1);
        if (v.length > 1) formatted += v.slice(1, 3);
        if (v.length > 3) formatted += ') ' + v.slice(3, 6);
        if (v.length > 6) formatted += ' ' + v.slice(6, 8);
        if (v.length > 8) formatted += ' ' + v.slice(8, 10);
        if (inp.value !== formatted) inp.value = formatted;
        if (v.length === 10) simNoImeiDoldur();
    }

    // Sƒ∞M NO alanƒ±ndan sadece rakamlarƒ± al (kayƒ±t i√ßin)
    function getSimNoRaw() {
        const inp = document.getElementById('simNo');
        return inp ? (inp.value || '').replace(/\D/g, '') : '';
    }

    // Herhangi bir SIM numarasƒ±nƒ± (Excel veya form) 10 haneli arama anahtarƒ±na √ßevir ‚Äî (5017224364), 5017224364, (501) 722 43 64 hepsi aynƒ±
    function simNoToKey(val) {
        if (val == null) return '';
        let s = (typeof val === 'number') ? String(Math.floor(val)) : String(val);
        s = s.replace(/\D/g, '');
        if (s.length >= 10) return s.slice(-10);
        return s;
    }

    // SIM-IMEI tablosunda anahtarlar yanlƒ±≈ü formatta y√ºklenmi≈ü olsa bile (√∂rn. eski kayƒ±tlar, bo≈üluklu / parantezli),
    // hepsini normalize edip doƒüru IMEI ve Plaka bilgisini bulmaya √ßalƒ±≈üan yardƒ±mcƒ±. D√∂n√º≈ü: { imei: string, plaka: string }
    function simNoImeiBul(rawSim) {
        const key = simNoToKey(rawSim);
        const empty = { imei: '', plaka: '' };
        if (!key) return empty;
        if (!SIM_IMEI) return empty;
        let val = null;
        if (Object.prototype.hasOwnProperty.call(SIM_IMEI, key)) {
            val = SIM_IMEI[key];
        } else {
            for (const k in SIM_IMEI) {
                if (!Object.prototype.hasOwnProperty.call(SIM_IMEI, k)) continue;
                if (simNoToKey(k) === key) { val = SIM_IMEI[k]; break; }
            }
        }
        if (val == null) return empty;
        if (typeof val === 'string') return { imei: val, plaka: '' };
        return { imei: val.imei || '', plaka: val.plaka || '' };
    }

    // Arama i√ßin denenecek anahtarlar (10 A 282 -> 10A282 ve 0282)
    function plakaAramaAnahtarlari(key) {
        const keys = [key];
        if (/^10A\d+$/i.test(key)) keys.push(plakaCanonicalKey(key.replace(/^10A/i, '')));
        return keys;
    }

    function baslikNormalize(str) {
        if (!str || typeof str !== 'string') return '';
        return str.toUpperCase()
            .replace(/ƒ∞/g, 'I').replace(/I/g, 'I').replace(/ƒ±/g, 'I')
            .replace(/ƒû/g, 'G').replace(/√ú/g, 'U').replace(/≈û/g, 'S').replace(/√ñ/g, 'O').replace(/√á/g, 'C');
    }

    function anaExcelYukle(fileInput) {
        if (!fileInput || !fileInput.files || !fileInput.files.length) return;
        if (typeof XLSX === 'undefined') { alert('XLSX k√ºt√ºphanesi y√ºklenemedi.'); return; }
        const file = fileInput.files[0];
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const wb = XLSX.read(e.target.result, { type: 'array' });
                const ws = wb.Sheets[wb.SheetNames[0]];
                const rows = XLSX.utils.sheet_to_json(ws, { header: 1, defval: '' });
                if (!rows || rows.length < 2) { alert('Excel\'de en az bir veri satƒ±rƒ± olmalƒ±.'); return; }
                const rawHeaders = (rows[0] || []).map(h => String(h == null ? '' : h).trim());
                const headersNorm = rawHeaders.map(h => baslikNormalize(h));
                const numCols = rawHeaders.length;
                function idxContains(needle) {
                    const n = baslikNormalize(needle);
                    return headersNorm.findIndex(h => h.indexOf(n) >= 0);
                }
                function idxExact(needle) {
                    const n = baslikNormalize(needle);
                    return headersNorm.findIndex(h => h === n || h.indexOf(n) >= 0);
                }
                let idxKullanildigiYer = idxContains('KULLANILDI');
                if (idxKullanildigiYer < 0) idxKullanildigiYer = idxContains('YER');
                let idxPlaka = idxContains('PLAKA');
                let idxCinsi = idxContains('CINSI');
                let idxMarka = idxContains('MARKA');
                let idxModelYili = idxContains('MODEL');
                if (idxModelYili < 0) idxModelYili = idxContains('YILI');
                let idxDurumu = headersNorm.findIndex(h => h === 'DURUMU' || (h.indexOf('DURUMU') >= 0 && h.indexOf('MODEL') < 0));
                let idxResmiSivil = idxContains('RESMI');
                if (idxResmiSivil < 0) idxResmiSivil = idxContains('SIVIL');
                if (idxResmiSivil < 0) idxResmiSivil = idxContains('SIV');
                var base = 0, plakaCol = 6;
                if (numCols >= 8) { base = 1; plakaCol = 7; }
                if (numCols >= 7) {
                    if (idxKullanildigiYer < 0) idxKullanildigiYer = base + 0;
                    if (idxCinsi < 0) idxCinsi = base + 1;
                    if (idxMarka < 0) idxMarka = base + 2;
                    if (idxModelYili < 0) idxModelYili = base + 3;
                    if (idxDurumu < 0) idxDurumu = base + 4;
                    if (idxResmiSivil < 0) idxResmiSivil = base + 5;
                    if (idxPlaka < 0) idxPlaka = plakaCol;
                }
                if (idxKullanildigiYer < 0 || idxPlaka < 0) { alert('Excel\'de KULLANILDIƒûI YER ve PLAKA NO s√ºtunlarƒ± olmalƒ± (en az 7 s√ºtun).'); return; }
                PLAKA_VERI = {};
                for (let r = 1; r < rows.length; r++) {
                    const row = rows[r] || [];
                    let plaka = String(row[idxPlaka] != null ? row[idxPlaka] : '').trim();
                    if (!plaka) continue;
                    const kullanildigiYer = String(row[idxKullanildigiYer] != null ? row[idxKullanildigiYer] : '').trim();
                    const cinsi = idxCinsi >= 0 ? String(row[idxCinsi] != null ? row[idxCinsi] : '').trim() : '';
                    const marka = idxMarka >= 0 ? String(row[idxMarka] != null ? row[idxMarka] : '').trim() : '';
                    const modelYili = idxModelYili >= 0 ? String(row[idxModelYili] != null ? row[idxModelYili] : '').trim() : '';
                    const durumu = idxDurumu >= 0 ? String(row[idxDurumu] != null ? row[idxDurumu] : '').trim() : '';
                    const resmiSivil = idxResmiSivil >= 0 ? String(row[idxResmiSivil] != null ? row[idxResmiSivil] : '').trim() : '';
                    const key = plakaNormalize(plaka);
                    PLAKA_VERI[key] = { kullanildigiYer, cinsi, marka, modelYili, durumu, resmiSivil };
                }
                const el = document.getElementById('listeDurum');
                if (el) { el.textContent = Object.keys(PLAKA_VERI).length + ' kayƒ±t (sabit ‚Äî her a√ßƒ±lƒ±≈üta y√ºkl√º)'; el.className = 'status-badge loaded'; }
                localStorage.setItem('nesne_takip_plaka_veri', JSON.stringify(PLAKA_VERI));
                plakaDegisti();
            } catch (err) { alert('Excel okunamadƒ±: ' + (err.message || err)); }
            fileInput.value = '';
        };
        reader.readAsArrayBuffer(file);
    }

    function cihazTuruExcelYukle(fileInput) {
        if (!fileInput || !fileInput.files || !fileInput.files.length) return;
        if (typeof XLSX === 'undefined') { alert('XLSX k√ºt√ºphanesi y√ºklenemedi.'); return; }
        const file = fileInput.files[0];
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const wb = XLSX.read(e.target.result, { type: 'array' });
                const ws = wb.Sheets[wb.SheetNames[0]];
                const rows = XLSX.utils.sheet_to_json(ws, { header: 1, defval: '' });
                if (!rows || rows.length < 2) { alert('Excel\'de en az bir veri satƒ±rƒ± olmalƒ±.'); return; }
                const rawHeaders = (rows[0] || []).map(h => String(h == null ? '' : h).trim());
                const headersNorm = rawHeaders.map(h => baslikNormalize(h));
                let idxPlaka = headersNorm.findIndex(h => h.indexOf('PLAKA') >= 0);
                let idxNtp = headersNorm.findIndex(h => h.indexOf('NTP') >= 0 && h.indexOf('TURU') >= 0);
                if (idxPlaka < 0 && rawHeaders.length >= 1) idxPlaka = 0;
                if (idxNtp < 0 && rawHeaders.length >= 2) idxNtp = 1;
                if (idxPlaka < 0 || idxNtp < 0) { alert('Excel\'de PLAKA ve NTP T√úR√ú s√ºtunlarƒ± olmalƒ± (veya 1. ve 2. s√ºtun).'); return; }
                PLAKA_NTP = {};
                let sayac = 0;
                for (let r = 1; r < rows.length; r++) {
                    const row = rows[r] || [];
                    const plaka = String(row[idxPlaka] != null ? row[idxPlaka] : '').trim();
                    const ntpTur = String(row[idxNtp] != null ? row[idxNtp] : '').trim();
                    if (!plaka || !ntpTur) continue;
                    var key = plakaCanonicalKey(plaka);
                    PLAKA_NTP[key] = ntpTur;
                    sayac++;
                }
                CIHAZ_TURU_SAYAC = sayac;
                const el = document.getElementById('durumCihazTuru');
                if (el) { el.textContent = sayac + ' plaka (sabit ‚Äî her a√ßƒ±lƒ±≈üta y√ºkl√º)'; el.className = 'status-badge loaded'; }
                localStorage.setItem('nesne_takip_plaka_ntp', JSON.stringify(PLAKA_NTP));
                localStorage.setItem('nesne_takip_cihaz_turu_sayac', String(sayac));
                plakaDegisti();
                fileInput.value = '';
            } catch (err) { alert('Excel okunamadƒ±: ' + (err.message || err)); }
        };
        reader.readAsArrayBuffer(file);
    }

    function cihazTuruListesiniSifirla() {
        PLAKA_NTP = {};
        CIHAZ_TURU_SAYAC = 0;
        localStorage.removeItem('nesne_takip_plaka_ntp');
        localStorage.removeItem('nesne_takip_cihaz_turu_sayac');
        const dc = document.getElementById('durumCihazTuru');
        if (dc) { dc.textContent = 'Dosya se√ßilmedi'; dc.className = 'status-badge empty'; }
        const fileInput = document.getElementById('excelCihazTuru');
        if (fileInput) fileInput.value = '';
        document.getElementById('cihazTuru').value = '';
        guncelleSayac();
    }

    function simImeiExcelYukle(fileInput) {
        if (!fileInput || !fileInput.files || !fileInput.files.length) return;
        if (typeof XLSX === 'undefined') { alert('XLSX k√ºt√ºphanesi y√ºklenemedi.'); return; }
        const file = fileInput.files[0];
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const wb = XLSX.read(e.target.result, { type: 'array' });
                const ws = wb.Sheets[wb.SheetNames[0]];
                const rows = XLSX.utils.sheet_to_json(ws, { header: 1, defval: '' });
                if (!rows || rows.length < 2) { alert('Excel\'de en az bir veri satƒ±rƒ± olmalƒ±.'); return; }
                const rawHeaders = (rows[0] || []).map(h => String(h == null ? '' : h).trim());
                const headersNorm = rawHeaders.map(h => baslikNormalize(h));
                let idxSim = headersNorm.findIndex(h => h.indexOf('SIM') >= 0 || h.indexOf('SIM NO') >= 0);
                let idxImei = headersNorm.findIndex(h => h.indexOf('IMEI') >= 0);
                let idxPlaka = headersNorm.findIndex(h => h.indexOf('PLAKA') >= 0);
                if (idxSim < 0) idxSim = 0;
                if (idxImei < 0) idxImei = 1;
                SIM_IMEI = {};
                let sayac = 0;
                for (let r = 1; r < rows.length; r++) {
                    const row = rows[r] || [];
                    const simHam = row[idxSim];
                    const imei = String(row[idxImei] != null ? row[idxImei] : '').trim();
                    const plaka = idxPlaka >= 0 ? String(row[idxPlaka] != null ? row[idxPlaka] : '').trim() : '';
                    const key = simNoToKey(simHam);
                    if (key.length >= 10 && imei) {
                        SIM_IMEI[key] = { imei: imei, plaka: plaka };
                        sayac++;
                    }
                }
                const el = document.getElementById('durumSimImei');
                let durumText = sayac + ' kayƒ±t (sabit ‚Äî her a√ßƒ±lƒ±≈üta y√ºkl√º)';
                if (idxPlaka >= 0) durumText += ' ‚Ä¢ Plaka s√ºtunu var';
                if (el) { el.textContent = durumText; el.className = 'status-badge loaded'; }
                localStorage.setItem('nesne_takip_sim_imei', JSON.stringify(SIM_IMEI));
                fileInput.value = '';
            } catch (err) { alert('Excel okunamadƒ±: ' + (err.message || err)); }
        };
        reader.readAsArrayBuffer(file);
    }

    function simImeiListesiniSifirla() {
        SIM_IMEI = {};
        localStorage.removeItem('nesne_takip_sim_imei');
        const el = document.getElementById('durumSimImei');
        if (el) { el.textContent = 'Dosya se√ßilmedi'; el.className = 'status-badge empty'; }
        const fileInput = document.getElementById('excelSimImei');
        if (fileInput) fileInput.value = '';
    }

    // HEK listesinde mi kontrol et (plaka veya kullanƒ±ldƒ±ƒüƒ± yer)
    function hekListesindeMi(plakaTam, kullanildigiYer) {
        if (!HEKDEN_GELENLER || !HEKDEN_GELENLER.length) return false;
        const plakaNorm = plakaNormalize(plakaTam || '');
        const plakaRakam = (plakaTam || '').replace(/\D/g, '') || '';
        const birimNorm = String(kullanildigiYer || '').trim().toUpperCase();
        for (let i = 0; i < HEKDEN_GELENLER.length; i++) {
            const h = String(HEKDEN_GELENLER[i] || '').trim();
            if (!h) continue;
            const hNorm = h.toUpperCase();
            if (plakaNorm && plakaNorm.indexOf(hNorm) !== -1) return true;
            if (plakaRakam && h.replace(/\D/g, '').indexOf(plakaRakam) !== -1) return true;
            if (plakaRakam && plakaRakam.indexOf(h.replace(/\D/g, '')) !== -1) return true;
            if (birimNorm && birimNorm.indexOf(hNorm) !== -1) return true;
        }
        return false;
    }

    // Sƒ∞M NO 10 hane olduƒüunda: IMEI doldur; SIM_IMEI'de plaka varsa plakayƒ± yazƒ±p plakaDegisti() tetikle; HEK listesindeyse uyarƒ± g√∂ster
    function simNoImeiDoldur() {
        const raw = getSimNoRaw();
        if (raw.length < 10) return;
        const bulunan = simNoImeiBul(raw);
        const imei = bulunan.imei;
        const plakaDeger = bulunan.plaka;
        const infoEl = document.getElementById('simImeiInfo');
        if (infoEl) {
            const key = simNoToKey(raw);
            const kayitSayisi = SIM_IMEI ? Object.keys(SIM_IMEI).length : 0;
            let msg = 'SIM-IMEI listesi: ' + kayitSayisi + ' kayƒ±t. Aranan SIM: ' + key + '. ';
            if (imei) msg += 'IMEI: ' + imei;
            else msg += 'Bu SIM i√ßin IMEI bulunamadƒ±.';
            if (plakaDeger) msg += ' Plaka: ' + plakaDeger;
            infoEl.textContent = msg;
            infoEl.style.display = 'block';
        }
        if (imei) {
            const inp = document.getElementById('imeiNo');
            if (inp) inp.value = imei;
        }
        if (plakaDeger) {
            var dig = String(plakaDeger).replace(/\D/g, '');
            var plakaRakam = dig;
            if (dig.length > 4 && dig.indexOf('10') === 0) plakaRakam = dig.slice(2);
            else if (dig.length > 4) plakaRakam = dig.slice(-4);
            if (plakaRakam) {
                var plakaInp = document.getElementById('plaka');
                if (plakaInp) {
                    plakaInp.value = plakaRakam;
                    plakaDegisti();
                }
            }
        }
        if (plakaDeger || imei) {
            var plakaTam = getPlakaTam();
            var kullanildigiYer = (document.getElementById('kullanildigiYer') || {}).value || '';
            if (hekListesindeMi(plakaTam, kullanildigiYer)) {
                alert('‚ö†Ô∏è HEKDEN GELENLER: Bu plaka / birim HEK listesinde yer alƒ±yor. L√ºtfen kontrol edin.');
            }
        }
    }

    function ntpBul(key) {
        if (!key) return '';
        var anahtarlar = plakaAramaAnahtarlari(key);
        for (var i = 0; i < anahtarlar.length; i++) {
            var k = anahtarlar[i];
            if (PLAKA_NTP[k]) return PLAKA_NTP[k];
        }
        var canonical = plakaCanonicalKey(key);
        if (PLAKA_NTP[canonical]) return PLAKA_NTP[canonical];
        if (/^\d+$/.test(key)) {
            var d = key.replace(/^0+/, '') || '0';
            var pad = d.padStart(4, '0');
            if (PLAKA_NTP[pad]) return PLAKA_NTP[pad];
            if (PLAKA_NTP[pad + 'A']) return PLAKA_NTP[pad + 'A'];
        }
        if (/^\d+A$/i.test(key)) {
            var rakam = key.replace(/A$/i, '').replace(/^0+/, '') || '0';
            var p4 = rakam.padStart(4, '0');
            if (PLAKA_NTP[p4 + 'A']) return PLAKA_NTP[p4 + 'A'];
            if (PLAKA_NTP[p4]) return PLAKA_NTP[p4];
        }
        return '';
    }

    function plakaDegisti() {
        const key = plakaNormalize(getPlakaTam());
        document.getElementById('cihazTuru').value = ntpBul(key);
        const anahtarlar = plakaAramaAnahtarlari(key);
        let veri = null;
        for (let i = 0; i < anahtarlar.length; i++) {
            if (PLAKA_VERI[anahtarlar[i]]) { veri = PLAKA_VERI[anahtarlar[i]]; break; }
        }
        if (!veri) {
            document.getElementById('kullanildigiYer').value = '';
            document.getElementById('cinsi').value = '';
            document.getElementById('marka').value = '';
            document.getElementById('modelYili').value = '';
            document.getElementById('durumu').value = '';
            document.getElementById('resmiSivil').value = '';
            return;
        }
        document.getElementById('kullanildigiYer').value = veri.kullanildigiYer || '';
        document.getElementById('cinsi').value = veri.cinsi || '';
        document.getElementById('marka').value = veri.marka || '';
        document.getElementById('modelYili').value = veri.modelYili || '';
        document.getElementById('durumu').value = veri.durumu || '';
        document.getElementById('resmiSivil').value = veri.resmiSivil || '';
    }

    function kaydet() {
        // Kaydetmeden hemen √∂nce Sƒ∞M listesinden IMEI doldurmayƒ± dene (blur tetiklenmemi≈ü olabilir)
        simNoImeiDoldur();
        siraNo++;
        const plaka = getPlakaTam();
        const kullanildigiYer = document.getElementById('kullanildigiYer').value.trim();
        const cinsi = document.getElementById('cinsi').value.trim();
        const marka = document.getElementById('marka').value.trim();
        const modelYili = document.getElementById('modelYili').value.trim();
        const durumu = document.getElementById('durumu').value.trim();
        const resmiSivil = document.getElementById('resmiSivil').value.trim();
        const cihazTuru = document.getElementById('cihazTuru').value.trim();
        const ekipKodu = document.getElementById('ekipKodu').value.trim();
        const simNo = document.getElementById('simNo').value.trim();
        const imeiNo = document.getElementById('imeiNo').value.trim();
        if (!getSimNoRaw() || getSimNoRaw().length < 10) { alert('Sƒ∞M NO zorunludur (10 hane: 5xx xxx xx xx).'); return; }
        const kayit = { sNo: siraNo, plaka, kullanildigiYer, cinsi, marka, modelYili, durumu, resmiSivil, cihazTuru, ekipKodu, simNo, imeiNo };
        KAYITLAR.push(kayit);
        localStorage.setItem('nesne_takip_kayitlar', JSON.stringify(KAYITLAR));
        localStorage.setItem('nesne_takip_sira_no', String(siraNo));
        listeyiCiz();
        document.getElementById('cinsi').value = '';
        document.getElementById('marka').value = '';
        document.getElementById('modelYili').value = '';
        document.getElementById('durumu').value = '';
        document.getElementById('resmiSivil').value = '';
        document.getElementById('ekipKodu').value = '';
        document.getElementById('simNo').value = '';
        document.getElementById('imeiNo').value = '';
        guncelleSayac();
    }

    function listeyiCiz() {
        const alan = document.getElementById('listeAlani');
        if (!alan) return;
        if (!KAYITLAR.length) { alan.innerHTML = '<p class="helper">Hen√ºz kayƒ±t yok.</p>'; return; }
        let html = '<table><thead><tr>';
        EXPORT_BASLIKLAR.forEach(h => { html += '<th>' + h + '</th>'; });
        html += '</tr></thead><tbody>';
        KAYITLAR.forEach(k => {
            html += '<tr><td>' + (k.sNo || '') + '</td><td>' + (k.kullanildigiYer || '') + '</td><td>' + (k.cinsi || '') + '</td><td>' + (k.marka || '') + '</td><td>' + (k.modelYili || '') + '</td><td>' + (k.durumu || '') + '</td><td>' + (k.resmiSivil || '') + '</td><td>' + (k.plaka || '') + '</td><td>' + (k.cihazTuru || '') + '</td><td>' + (k.ekipKodu || '') + '</td><td>' + (k.simNo || '') + '</td><td>' + (k.imeiNo || '') + '</td></tr>';
        });
        html += '</tbody></table>';
        alan.innerHTML = html;
    }

    function arsiviCiz() {
        const alan = document.getElementById('arsivAlani');
        if (!alan) return;
        if (!ARSIV_KAYITLAR.length) { alan.innerHTML = '<p class="helper">Ar≈üivde kayƒ±t yok.</p>'; return; }
        let html = '<table><thead><tr>';
        html += '<th>S. N.</th><th>Bƒ∞Rƒ∞Mƒ∞</th><th>PLAKA</th><th>Cƒ∞NSƒ∞</th><th>MARKA</th><th>MODEL</th><th>DURUM</th><th>RESMƒ∞/Sƒ∞Vƒ∞L</th><th>Cƒ∞HAZ T√úR√ú</th><th>EKƒ∞P KODU</th><th>Sƒ∞M NO</th><th>IMEI NO</th>';
        html += '</tr></thead><tbody>';
        ARSIV_KAYITLAR.forEach(k => {
            html += '<tr><td>' + (k.sNo || '') + '</td><td>' + (k.kullanildigiYer || '') + '</td><td>' + (k.plaka || '') + '</td><td>' + (k.cinsi || '') + '</td><td>' + (k.marka || '') + '</td><td>' + (k.modelYili || '') + '</td><td>' + (k.durumu || '') + '</td><td>' + (k.resmiSivil || '') + '</td><td>' + (k.cihazTuru || '') + '</td><td>' + (k.ekipKodu || '') + '</td><td>' + (k.simNo || '') + '</td><td>' + (k.imeiNo || '') + '</td></tr>';
        });
        html += '</tbody></table>';
        alan.innerHTML = html;
    }

    function exceleAktar() {
        if (!KAYITLAR.length) { alert('Aktarƒ±lacak kayƒ±t yok.'); return; }
        if (typeof XLSX === 'undefined') { alert('XLSX k√ºt√ºphanesi y√ºklenemedi.'); return; }
        const rows = KAYITLAR.map(k => [
            k.sNo || '', k.kullanildigiYer || '', k.cinsi || '', k.marka || '', k.modelYili || '', k.durumu || '', k.resmiSivil || '', k.plaka || '', k.cihazTuru || '', k.ekipKodu || '', k.simNo || '', k.imeiNo || ''
        ]);
        const ws = XLSX.utils.aoa_to_sheet([EXPORT_BASLIKLAR, ...rows]);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'Kayitlar');
        XLSX.writeFile(wb, 'nesne_takip_kayitlar.xlsx');
    }

    function arsiveTasi() {
        if (!KAYITLAR.length) { alert('Ar≈üivlenecek kayƒ±t yok.'); return; }
        ARSIV_KAYITLAR = ARSIV_KAYITLAR.concat(KAYITLAR);
        KAYITLAR = [];
        localStorage.setItem('nesne_takip_kayitlar', JSON.stringify(KAYITLAR));
        localStorage.setItem('nesne_takip_arsiv', JSON.stringify(ARSIV_KAYITLAR));
        listeyiCiz();
        arsiviCiz();
        excelGonderButonGuncelle();
        guncelleSayac();
    }

    function excelGonderButonGuncelle() {
        const btn = document.getElementById('btnExcelGonder');
        if (btn) {
            btn.disabled = ARSIV_KAYITLAR.length < 5;
            btn.title = ARSIV_KAYITLAR.length >= 5 ? 'Excel listesini indirir ve WhatsApp Web a√ßar' : 'Ar≈üivde en az 5 kayƒ±t olunca aktif olur (≈üu an: ' + ARSIV_KAYITLAR.length + ')';
        }
    }

    function hekListesiKaydet() {
        const ta = document.getElementById('hekListesi');
        if (!ta) return;
        const satirlar = (ta.value || '').split(/\r?\n/).map(function(s) { return s.trim(); }).filter(Boolean);
        HEKDEN_GELENLER = satirlar;
        localStorage.setItem('nesne_takip_hekden_gelenler', JSON.stringify(HEKDEN_GELENLER));
    }

    function yoneticiPaneliAc() {
        const overlay = document.getElementById('yoneticiPaneliOverlay');
        const ta = document.getElementById('yoneticiNumaralar');
        if (ta) ta.value = (localStorage.getItem('nesne_takip_yonetici_numaralar') || '').replace(/\|/g, '\n');
        const hekTa = document.getElementById('hekListesi');
        if (hekTa) hekTa.value = (HEKDEN_GELENLER || []).join('\n');
        const dsi = document.getElementById('durumSimImei');
        if (dsi) {
            const sn = Object.keys(SIM_IMEI).length;
            dsi.textContent = sn > 0 ? sn + ' kayƒ±t (sabit ‚Äî her a√ßƒ±lƒ±≈üta y√ºkl√º)' : 'Dosya se√ßilmedi';
            dsi.className = 'status-badge ' + (sn > 0 ? 'loaded' : 'empty');
        }
        if (overlay) overlay.classList.add('acik');
    }
    function yoneticiPaneliKapat() {
        const overlay = document.getElementById('yoneticiPaneliOverlay');
        if (overlay) overlay.classList.remove('acik');
    }
    function yoneticiNumaralariKaydet() {
        const ta = document.getElementById('yoneticiNumaralar');
        if (!ta) return;
        const satirlar = (ta.value || '').split(/\r?\n/).map(function(s) { return s.replace(/\D/g, '').trim(); }).filter(function(s) { return s.length >= 10; });
        localStorage.setItem('nesne_takip_yonetici_numaralar', satirlar.join('\n'));
    }
    function getYoneticiNumaralari() {
        const raw = localStorage.getItem('nesne_takip_yonetici_numaralar') || '';
        return raw.split(/\r?\n/).map(function(s) { return s.replace(/\D/g, '').trim(); }).filter(function(s) { return s.length >= 10; });
    }

    function excelSayfaBicimle(ws) {
        if (!ws || !ws['!ref']) return;
        const range = XLSX.utils.decode_range(ws['!ref']);
        const colCount = range.e.c - range.s.c + 1;
        const rowCount = range.e.r - range.s.r + 1;
        const wchList = [];
        for (let c = 0; c < colCount; c++) {
            let maxLen = 10;
            for (let r = 0; r <= rowCount; r++) {
                const cellRef = XLSX.utils.encode_cell({ r: r, c: c });
                const cell = ws[cellRef];
                const val = cell ? (cell.v != null ? String(cell.v) : '') : '';
                if (val.length > maxLen) maxLen = Math.min(val.length + 1, 50);
            }
            wchList.push({ wch: maxLen });
        }
        ws['!cols'] = wchList;
        const rowHeights = [];
        for (let r = 0; r <= rowCount; r++) rowHeights.push({ hpt: 18 });
        ws['!rows'] = rowHeights;
        var borderStyle = { top: { style: 'thin' }, bottom: { style: 'thin' }, left: { style: 'thin' }, right: { style: 'thin' } };
        for (var r = range.s.r; r <= range.e.r; r++) {
            for (var c = range.s.c; c <= range.e.c; c++) {
                var ref = XLSX.utils.encode_cell({ r: r, c: c });
                if (!ws[ref]) ws[ref] = { v: '' };
                if (!ws[ref].s) ws[ref].s = {};
                ws[ref].s.border = borderStyle;
            }
        }
    }

    // Birim arama penceresi
    function birimAramaAc() {
        const input = document.getElementById('birimArama');
        if (!input) return;
        const aranan = (input.value || '').trim();
        if (!aranan) {
            alert('L√ºtfen birim / kullanƒ±ldƒ±ƒüƒ± yer veya cihaz t√ºr√º (NTP t√ºr√º) girin.');
            return;
        }
        const termNorm = aranan.toLocaleUpperCase('tr-TR');
        const kayitlar = [];

        // Cihaz listesini Cƒ∞HAZ T√úR√ú dosyasƒ±ndaki plakalar √ºzerinden kur,
        // birim/kullanƒ±ldƒ±ƒüƒ± yer bilgisini ise ANA Lƒ∞STE'den (PLAKA_VERI) √ßapraz sorgu ile √ßek
        Object.keys(PLAKA_NTP).forEach(function(plakaKey) {
            const v = PLAKA_VERI[plakaKey] || {};
            const birimHam = v.kullanildigiYer || '';
            const birim = String(birimHam).toLocaleUpperCase('tr-TR');
            const cihazTuru = ntpBul(plakaKey) || '';
            const cihazTuruNorm = String(cihazTuru).toLocaleUpperCase('tr-TR');
            const birimEslesti = birim && birim.indexOf(termNorm) !== -1;
            const cihazTuruEslesti = cihazTuruNorm && cihazTuruNorm.indexOf(termNorm) !== -1;
            if (birimEslesti || cihazTuruEslesti) {
                kayitlar.push({
                    plaka: plakaKey,
                    kullanildigiYer: birimHam,
                    cinsi: v.cinsi || '',
                    marka: v.marka || '',
                    modelYili: v.modelYili || '',
                    durumu: v.durumu || '',
                    resmiSivil: v.resmiSivil || '',
                    cihazTuru: cihazTuru
                });
            }
        });
        const baslikEl = document.getElementById('birimAramaBaslik');
        const sonucEl = document.getElementById('birimAramaSonuc');
        if (!sonucEl) return;

        if (baslikEl) {
            const upperName = aranan.toLocaleUpperCase('tr-TR');
            // Cihaz t√ºr√º (NTP T√úR√ú: ASELSAN, ATOSƒ∞S, Dƒ∞ƒûER vb.) bazƒ±nda sayƒ±m
            const turSayac = {};
            kayitlar.forEach(function (k) {
                const t = String(k.cihazTuru || '').trim();
                if (!t) return;
                const key = t.toLocaleUpperCase('tr-TR');
                turSayac[key] = (turSayac[key] || 0) + 1;
            });
            const turParca = Object.keys(turSayac).map(function (t) {
                return turSayac[t] + ' ' + t;
            }).join(', ');

            let text = '"' + upperName + '" ƒ∞√áƒ∞N BULUNAN Cƒ∞HAZ SAYISI: ' + kayitlar.length;
            if (turParca) {
                text += ' (' + turParca + ')';
            }
            baslikEl.textContent = text;
        }
        if (!kayitlar.length) {
            sonucEl.innerHTML = '<p class="helper">Bu birim veya cihaz t√ºr√º i√ßin kayƒ±tlƒ± cihaz bulunamadƒ±.</p>';
        } else {
            let html = '<table><thead><tr><th>Bƒ∞Rƒ∞M</th><th>PLAKA</th><th>Cƒ∞NSƒ∞</th><th>MARKA</th><th>MODEL</th><th>DURUM</th><th>RESMƒ∞/Sƒ∞Vƒ∞L</th><th>Cƒ∞HAZ T√úR√ú</th></tr></thead><tbody>';
            kayitlar.forEach(function(k) {
                html += '<tr>' +
                    '<td>' + (k.kullanildigiYer || '') + '</td>' +
                    '<td>' + (k.plaka || '') + '</td>' +
                    '<td>' + (k.cinsi || '') + '</td>' +
                    '<td>' + (k.marka || '') + '</td>' +
                    '<td>' + (k.modelYili || '') + '</td>' +
                    '<td>' + (k.durumu || '') + '</td>' +
                    '<td>' + (k.resmiSivil || '') + '</td>' +
                    '<td>' + (k.cihazTuru || '') + '</td>' +
                    '</tr>';
            });
            html += '</tbody></table>';
            sonucEl.innerHTML = html;
        }
        const overlay = document.getElementById('birimAramaOverlay');
        if (overlay) overlay.classList.add('acik');
    }

    function birimAramaKapat() {
        const overlay = document.getElementById('birimAramaOverlay');
        if (overlay) overlay.classList.remove('acik');
    }

    // Ar≈üivi PDF √∂nizleme olarak yeni pencerede g√∂ster
    function arsivPdfGoster() {
        if (!ARSIV_KAYITLAR.length) {
            alert('Ar≈üivde g√∂sterilecek kayƒ±t yok.');
            return;
        }
        const win = window.open('', '_blank');
        if (!win) {
            alert('Pop-up engellendi. L√ºtfen bu site i√ßin a√ßƒ±lƒ±r pencere izni verin.');
            return;
        }
        let html = '<!DOCTYPE html><html lang="tr"><head><meta charset="UTF-8"><title>NTP Cihaz Ar≈üivi</title>';
        html += '<style>';
        html += 'body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;margin:20px;background:#f3f4f6;color:#111827;}';
        html += 'h1{font-size:20px;margin-bottom:4px;color:#111827;}';
        html += 'p.sub{font-size:12px;margin-top:0;margin-bottom:16px;color:#4b5563;}';
        html += 'table{width:100%;border-collapse:collapse;font-size:11px;background:white;border-radius:8px;overflow:hidden;box-shadow:0 1px 4px rgba(15,23,42,0.15);}';
        html += 'th,td{border:1px solid #e5e7eb;padding:6px 8px;text-align:left;}';
        html += 'th{background:#111827;color:#f9fafb;font-weight:600;}';
        html += 'tr:nth-child(even){background:#f9fafb;}';
        html += '</style></head><body>';
        html += '<h1>NTP Cihaz Ar≈üivi</h1>';
        html += '<p class="sub">Ar≈üivdeki cihaz sayƒ±sƒ±: ' + ARSIV_KAYITLAR.length + '</p>';
        html += '<table><thead><tr>';
        html += '<th>#</th><th>Bƒ∞Rƒ∞Mƒ∞</th><th>PLAKA</th><th>EKƒ∞P KODU</th><th>MARKA</th><th>Cƒ∞HAZ T√úR√ú</th><th>Sƒ∞M NO</th><th>IMEI / SERƒ∞ NO</th>';
        html += '</tr></thead><tbody>';
        ARSIV_KAYITLAR.forEach((k, idx) => {
            html += '<tr>' +
                '<td>' + (idx + 1) + '</td>' +
                '<td>' + (k.kullanildigiYer || '') + '</td>' +
                '<td>' + (k.plaka || '') + '</td>' +
                '<td>' + (k.ekipKodu || '') + '</td>' +
                '<td>' + (k.marka || '') + '</td>' +
                '<td>' + (k.cihazTuru || '') + '</td>' +
                '<td>' + (k.simNo || '') + '</td>' +
                '<td>' + (k.imeiNo || '') + '</td>' +
                '</tr>';
        });
        html += '</tbody></table>';
        html += '</body></html>';
        win.document.open();
        win.document.write(html);
        win.document.close();
        win.focus();
    }

    // √ústte kalan cihaz sayacƒ±
    function guncelleSayac() {
        const el = document.getElementById('headerCounter');
        if (!el) return;
        const toplam = TOPLAM_CIHAZ || 0;
        const takilan = (KAYITLAR.length || 0) + (ARSIV_KAYITLAR.length || 0);
        const kalan = Math.max(toplam - takilan, 0);
        el.textContent = 'Kalan cihaz: ' + kalan;
    }

    function excelGonderWhatsApp() {
        let kaynak = ARSIV_KAYITLAR;
        if (ARSIV_KAYITLAR.length < 5) { alert('Ar≈üivde en az 5 kayƒ±t olmalƒ±.'); return; }
        if (typeof XLSX === 'undefined') { alert('XLSX k√ºt√ºphanesi y√ºklenemedi.'); return; }
        const rows = kaynak.map(k => [
            k.plaka || '', k.kullanildigiYer || '', k.ekipKodu || '', k.simNo || '', k.imeiNo || ''
        ]);
        const ws = XLSX.utils.aoa_to_sheet([GONDER_BASLIKLAR, ...rows]);
        excelSayfaBicimle(ws);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'Liste');
        const dosyaAdi = 'nesne_takip_whatsapp_' + new Date().toISOString().slice(0,10) + (testModu ? '_TEST' : '') + '.xlsx';
        XLSX.writeFile(wb, dosyaAdi);
        window.open('https://web.whatsapp.com', '_blank');
        const numaralar = getYoneticiNumaralari();
        numaralar.forEach(function(num) {
            var n = num.replace(/^0+/, '');
            if (n.length === 10 && n[0] === '5') n = '90' + n;
            else if (n.length === 11 && n[0] === '0') n = '90' + n.slice(1);
            else if (n.length < 12) n = '90' + n;
            if (n.length >= 12) setTimeout(function() { window.open('https://wa.me/' + n, '_blank'); }, 400 + numaralar.indexOf(num) * 300);
        });
    }

    // Sayfa a√ßƒ±lƒ±≈üƒ±nda sabit verileri localStorage'dan y√ºkle (cihaz t√ºr√º listesi bir kez y√ºklenince kalƒ±cƒ±)
    function sabitVerileriYukle() {
        try {
            const pv = localStorage.getItem('nesne_takip_plaka_veri');
            if (pv) {
                const parsed = JSON.parse(pv);
                if (parsed && typeof parsed === 'object' && !Array.isArray(parsed)) PLAKA_VERI = parsed;
            }
            const pntp = localStorage.getItem('nesne_takip_plaka_ntp');
            if (pntp) {
                try {
                    const parsed = JSON.parse(pntp);
                    if (parsed && typeof parsed === 'object' && !Array.isArray(parsed)) PLAKA_NTP = parsed;
                } catch (e2) {}
            }
            const sc = localStorage.getItem('nesne_takip_cihaz_turu_sayac');
            if (sc) CIHAZ_TURU_SAYAC = parseInt(sc, 10) || 0;
            else if (Object.keys(PLAKA_NTP).length > 0) CIHAZ_TURU_SAYAC = Object.keys(PLAKA_NTP).length;
            const simImeiRaw = localStorage.getItem('nesne_takip_sim_imei');
            if (simImeiRaw) {
                try {
                    const parsed = JSON.parse(simImeiRaw);
                    if (parsed && typeof parsed === 'object' && !Array.isArray(parsed)) {
                        SIM_IMEI = {};
                        for (const k in parsed) {
                            if (!Object.prototype.hasOwnProperty.call(parsed, k)) continue;
                            const v = parsed[k];
                            if (typeof v === 'string') SIM_IMEI[k] = { imei: v, plaka: '' };
                            else SIM_IMEI[k] = { imei: v.imei || '', plaka: v.plaka || '' };
                        }
                    }
                } catch (e2) {}
            }
            const hekRaw = localStorage.getItem('nesne_takip_hekden_gelenler');
            if (hekRaw) {
                try {
                    const arr = JSON.parse(hekRaw);
                    if (Array.isArray(arr)) HEKDEN_GELENLER = arr;
                } catch (e2) {}
            }
            const pb = localStorage.getItem('nesne_takip_plaka_birim');
            if (pb && Object.keys(PLAKA_VERI).length === 0) {
                const eski = JSON.parse(pb);
                Object.keys(eski).forEach(function(p) {
                    var v = typeof eski[p] === 'object' ? eski[p] : { kullanildigiYer: eski[p] };
                    PLAKA_VERI[plakaNormalize(p)] = { kullanildigiYer: v.kullanildigiYer || v.birim || '', cinsi: v.cinsi || v.subeCinsi || '', marka: v.marka || '', modelYili: v.modelYili || v.modelYil || '', durumu: v.durumu || '', resmiSivil: v.resmiSivil || v.resmiSiv || '' };
                });
            }
            const ky = localStorage.getItem('nesne_takip_kayitlar');
            if (ky) KAYITLAR = JSON.parse(ky);
            const ars = localStorage.getItem('nesne_takip_arsiv');
            if (ars) ARSIV_KAYITLAR = JSON.parse(ars);
            const sn = localStorage.getItem('nesne_takip_sira_no');
            if (sn) siraNo = parseInt(sn, 10) || 0;
            // Toplam takƒ±lacak cihaz sayƒ±sƒ±, Cƒ∞HAZ T√úR√ú listesinden (plaka + NTP t√ºr√º) alƒ±nƒ±r
            TOPLAM_CIHAZ = CIHAZ_TURU_SAYAC || Object.keys(PLAKA_NTP).length || 0;
        } catch (e) {}
    }

    window.onload = function() {
        sabitVerileriYukle();
        const el = document.getElementById('listeDurum');
        if (el) {
            const n = Object.keys(PLAKA_VERI).length;
            el.textContent = n ? n + ' kayƒ±t (sabit ‚Äî her a√ßƒ±lƒ±≈üta y√ºkl√º)' : 'Dosya se√ßilmedi';
            el.className = 'status-badge ' + (n ? 'loaded' : 'empty');
        }
        const dc = document.getElementById('durumCihazTuru');
        if (dc) {
            const cn = CIHAZ_TURU_SAYAC;
            dc.textContent = cn > 0 ? cn + ' plaka (sabit ‚Äî her a√ßƒ±lƒ±≈üta y√ºkl√º)' : 'Dosya se√ßilmedi';
            dc.className = 'status-badge ' + (cn > 0 ? 'loaded' : 'empty');
        }
        const dsi = document.getElementById('durumSimImei');
        if (dsi) {
            const sn = Object.keys(SIM_IMEI).length;
            dsi.textContent = sn > 0 ? sn + ' kayƒ±t (sabit ‚Äî her a√ßƒ±lƒ±≈üta y√ºkl√º)' : 'Dosya se√ßilmedi';
            dsi.className = 'status-badge ' + (sn > 0 ? 'loaded' : 'empty');
        }
        excelGonderButonGuncelle();
        listeyiCiz();
        arsiviCiz();
        guncelleSayac();
    };
</script>
</body>
</html>
